server {

    ################################################
    # Базовые параметры HTTP-виртуального хоста
    ################################################
    # Слушаем HTTP на 80 порту для IPv4 и IPv6.
    listen 80 default_server;
    listen [::]:80 default_server;

    access_log  /var/log/nginx/host.access.log  structured_log;
    error_log   /var/log/nginx/host.error.log;

    # Явно переназначаем страницы ошибок на именованные локации —
    # это позволяет обойти rewrite/if-правила и канонизацию для внутренних URI ошибок.
    error_page 404               @error404;
    error_page 403               @error403;
    error_page 500 502 503 504   @error50x;

    # Универсальный редирект HTTP -> HTTPS
    # Перенаправляет любой запрос на соответствующий URL с протоколом https
    # с сохранением полного URI (path и query string).
    # return 301 https://$host$request_uri;

    location / {
        root   /usr/local/openresty/nginx/html;
        index  index.html index.htm index.php;

        autoindex off;

        try_files $uri $uri/ =404;

    }

    location /.well-known/appspecific/ {
        access_log off;
        return 204;
    }

    ################################################
    # Ограничение методов
    ################################################
    # Ограничиваем список разрешённых HTTP-методов до безопасного минимума.
    # Сейчас разрешены только GET, HEAD и POST; всё остальное вернёт 405.
    if ($request_method !~ "^(GET|HEAD|POST)$") {
        return 405;
    }

    ################################################
    # Статика (CSS/JS/картинки/шрифты)
    ################################################
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|webp|svg|ttf|woff|woff2)$ {
        root /var/www/default/public/static;
        access_log off;                    # Меньше шума и нагрузки на диск.
        expires 30d;                       # Долгий кеш браузера.
        add_header Cache-Control "public"; # Явно разрешаем кеширование.
    }



    # Именованные локации для error_page — обходят rewrite-фазу и правила канонизации.
    location @error404 {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /404.html =404;
        access_log off;
        error_log off;
    }

    location @error403 {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /403.html =403;
        access_log off;
        error_log off;
    }

    location @error50x {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /50x.html =500;
        access_log off;
        error_log off;
    }

    ################################################
    # Технические служебные файлы
    ################################################
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    ################################################
    # Модуль основных редиректов и защиты URL/файлов
    ################################################
    # Чтобы не захламлять основной server { } множеством if/locations, выносим
    # канонизацию URL и базовые security-паттерны в отдельный модуль
    # app_redirects_security.conf. Здесь собраны:
    #   - редиректы /index.php → /, удаление хвостового "?", множественных слэшей,
    #     добавление завершающего / для «чистых» путей;
    #   - простые фильтры SQLi/XSS по QUERY_STRING;
    #   - защита от path traversal, прямого доступа к конфигам и чувствительным
    #     директориям;
    #   - запрет .php в /upload;
    #   - защита от хотлинкинга картинок;
    #   - блокировка dot-файлов, VCS-директорий и резервных файлов.
    include /etc/nginx/sites-available/default/app_redirects_security.conf;

}
