#
# app_upstream.conf — upstream‑группа backend‑серверов для приложения.
# Этот файл описывает пул backend‑узлов, к которым Nginx будет проксировать запросы,
# и может подключаться из нескольких server { } блоков для переиспользования одной группы.
#

upstream backend_upstream {
    #
    # РЕЖИМ БАЛАНСИРОВКИ
    #
    # По умолчанию используется weighted round‑robin:
    # запросы распределяются между серверами пропорционально их weight.
    #
    # Для привязки пользователя к одному backend‑у (session persistence)
    # можно включить ip_hash (по IP клиента) или использовать hash по cookie.
    #
    # ip_hash;
    # hash $cookie_session_id consistent;
    #
    # Также доступны least_conn / random
    # Примеры:
    #   least_conn;        # трафик на сервер с наименьшим числом активных соединений
    #   random two least_conn;  # случайный выбор среди "наименее загруженных"

    #
    # CЕРВЕРЫ BACKEND‑ПУЛА
    #
    # Параметры:
    #   weight       — относительный вес узла в round‑robin.
    #   max_fails    — сколько неудачных попыток за fail_timeout считать критичным.
    #   fail_timeout — окно времени, в течение которого считаются ошибки, и период бана.
    #   backup       — запасной сервер, используется только при недоступности основных.
    #
    # "Неудачной попыткой" обычно считается ошибка connect/read/write в рамках next_upstream.

    # более мощный узел с повышенным весом
    server 10.0.0.1:9000 weight=5 max_fails=3 fail_timeout=30s;

    # обычные узлы
    server 10.0.0.2:9000 max_fails=3 fail_timeout=30s;
    server 10.0.0.3:9000 max_fails=3 fail_timeout=30s;

    # запасной сервер — используется, если все основные считаются недоступными
    server 10.0.0.4:9000 backup;

    #
    # KEEPALIVE ДЛЯ UPSTREAM
    #
    # keepalive N — включает пул постоянных (persistent) HTTP‑соединений к backend‑ам.
    # На каждый worker Nginx будет держать до N idle‑соединений к каждому upstream,
    # переиспользуя их для новых запросов вместо установления новых TCP‑соединений.
    # Это уменьшает накладные расходы на TCP‑handshake при большом RPS и снижает latency.
    #
    # Важно:
    #   * Нужны proxy_http_version 1.1 и proxy_set_header Connection ""; на уровне location.
    #   * Значение следует подбирать по нагрузке; 64 — безопасное стартовое значение.

    keepalive 64;
}