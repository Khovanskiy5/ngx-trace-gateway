server {

    ################################################
    # Базовые параметры HTTP-виртуального хоста
    ################################################
    # Слушаем HTTP на 80 порту для IPv4 и IPv6.
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ssl_certificate /path/to/your/fullchain.pem;        # содержит сертификат и цепочку
    ssl_certificate_key /path/to/your/private.key;      # приватный ключ
    ssl_trusted_certificate /path/to/ca_chain.pem;      # цепочка доверия

    access_log  /var/log/nginx/host.access.log  structured_log;
    error_log   /var/log/nginx/host.error.log;
    log_not_found off;

    # Явно на уровне сервера переназначаем страницы ошибок на именованные локации
    error_page 404               @error404;
    error_page 403               @error403;
    error_page 500 502 503 504   @error50x;

    # Универсальный редирект HTTP -> HTTPS
    # Перенаправляет любой запрос на соответствующий URL с протоколом https
    # с сохранением полного URI (path и query string).
    # return 301 https://$host$request_uri;

    location / {
        root   /usr/local/openresty/nginx/html;
        index  index.html index.htm index.php;

        autoindex off;
    }

    ################################################
    # Статика (CSS/JS/картинки/шрифты)
    ################################################
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|webp|svg|ttf|woff|woff2)$ {
        root /var/www/example.com/public;
        access_log off;                    # Меньше шума и нагрузки на диск.
        log_not_found off;
        expires 30d;                       # Долгий кеш браузера.
        add_header Cache-Control "public"; # Явно разрешаем кеширование.
    }

    ################################################
    # Простой пример: проксирование в upstream-группу
    ################################################
    # Все запросы к /api/ будут проксироваться на backend_upstream,
    # определённый в upstream.conf
    location ^~ /api/ {
        proxy_pass http://backend_upstream;

        # Для полноценного keepalive к upstream можно (по необходимости)
        # переопределить заголовок Connection, иначе действует глобальная
        # схема из global_proxy.conf (Upgrade/close):
        # proxy_set_header Connection "";
    }

    location /.well-known/appspecific/ {
        access_log off;
        log_not_found off;
        return 204;
    }

    ################################################
    # Ограничение методов
    ################################################
    # Ограничиваем список разрешённых HTTP-методов до безопасного минимума.
    # Сейчас разрешены только GET, HEAD и POST; всё остальное вернёт 405.
    if ($request_method !~ "^(GET|HEAD|POST)$") {
        return 405;
    }


    # Внутренние локации для выдачи кастомных страниц ошибок.
    # Общая каталожная локация для всех файлов ошибок
    location ^~ /errors/ {
        internal;
        alias /var/www/errors/public/;
        access_log off;
        # Включаем минимальный уровень логирования, чтобы не скрывать проблемы чтения файла
        error_log off;
    }

    location = /errors/404.html {
        internal;
        alias /var/www/errors/public/404.html;
        access_log off;
        error_log off;
    }

    location = /errors/403.html {
        internal;
        alias /var/www/errors/public/403.html;
        access_log off;
        error_log off;
    }

    location = /errors/50x.html {
        internal;
        alias /var/www/errors/public/50x.html;
        access_log off;
        error_log off;
    }

    # Именованные локации для error_page — обходят rewrite-фазу и правила канонизации.
    location @error404 {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /404.html =404;
        access_log off;
        error_log off;
    }

    location @error403 {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /403.html =403;
        access_log off;
        error_log off;
    }

    location @error50x {
        internal;
        root /var/www/errors/public;
        # Отдаём файл напрямую без повторного прохода по rewrite-фазе
        try_files /50x.html =500;
        access_log off;
        error_log off;
    }

    ################################################
    # Технические служебные файлы
    ################################################
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    ################################################
    # Модуль основных редиректов и защиты URL/файлов
    ################################################
    # Чтобы не захламлять основной server { } множеством if/locations, выносим
    # канонизацию URL и базовые security-паттерны в отдельный модуль
    # app_redirects_security.conf. Здесь собраны:
    #   - редиректы /index.php → /, удаление хвостового "?", множественных слэшей,
    #     добавление завершающего / для «чистых» путей;
    #   - простые фильтры SQLi/XSS по QUERY_STRING;
    #   - защита от path traversal, прямого доступа к конфигам и чувствительным
    #     директориям;
    #   - запрет .php в /upload;
    #   - защита от хотлинкинга картинок;
    #   - блокировка dot-файлов, VCS-директорий и резервных файлов.
    include /etc/nginx/sites-available/default/app_redirects_security.conf;


}

############################################################
# Дополнительный HTTPS-сервер: https://www.example.com -> https://example.com
############################################################
server {
    listen      443 ssl http2;
    server_name www.example.com;

    access_log  off;
    error_log   off;
    log_not_found off;

    ssl_certificate /path/to/your/fullchain.pem;        # содержит сертификат и цепочку
    ssl_certificate_key /path/to/your/private.key;      # приватный ключ
    ssl_trusted_certificate /path/to/ca_chain.pem;      # цепочка доверия

    # Цель — сделать example.com единственным canonical-доменом.
    return 301 https://example.com$request_uri;
}