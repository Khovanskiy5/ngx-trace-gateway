############################################################
# default.conf — «тонкий» агрегатор конфигурации сайта
#
# Назначение
#   Этот файл намеренно сделан минимальным (тонким): он содержит
#   только общие вспомогательные директивы и подключения (include)
#   к полноценным server-блокам для HTTP/HTTPS. Вся бизнес-логика,
#   роутинг, редиректы и безопасность вынесены в другие файлы.
#
# Где искать остальное
#   - HTTP-виртуальный хост:   /etc/nginx/sites-available/default/http_server.conf
#   - HTTPS-виртуальный хост:  /etc/nginx/sites-available/default/https_server.conf
#   - Апстримы/бекенды:        /etc/nginx/sites-available/default/upstream.conf
#   - Правила редиректов и базовой защиты:
#       /etc/nginx/sites-available/default/app_redirects_security.conf
#   - Глобальные настройки (gzip/proxy/ssl и пр.):
#       /etc/nginx/conf.d/globals/*.conf
#
# Как включить HTTPS
#   Раскомментируйте строку include для https_server.conf ниже. Убедитесь,
#   что SSL-сертификаты корректно сконфигурированы в global_ssl.conf и/или
#   в самом https_server.conf.
#
# Примечание о канонизации слэша
#   Ниже определён map $uri → $needs_slash. Он помогает решать, нужно ли
#   добавлять завершающий «/» к «чистым» путям (без расширения файла).
#   Значение 1 — добавить «/», значение 0 — оставить как есть.
#   Логику применения смотрите в http_server.conf.
############################################################

# Определяем, нужно ли добавлять завершающий «/» к URI без расширения
map $uri $needs_slash {
    ~\.[A-Za-z0-9]+$  0;  # Путь указывает на файл (в т.ч. многоуровневые /foo/bar.html) — слэш не добавляем
    ~/$               0;  # Уже оканчивается на «/» — ничего не меняем
    ~^/$              0;  # Корень сайта — без изменений
    ~^/nginx_status$  0;  # Служебный endpoint метрик — не канонизируем слэш
    default           1;  # Остальные «чистые» пути — добавляем завершающий «/»
}

# Подключаем upstream-группы бэкендов для сайта (http-контекст)
# upstream.conf: определение upstream backend_upstream { ... }
include /etc/nginx/sites-available/default/upstream.conf;

# Подключаем HTTP-виртуальный хост (порт 80)
include /etc/nginx/sites-available/default/http_server.conf;

# Подключение HTTPS-виртуального хоста (порт 443)
# Чтобы включить, раскомментируйте следующую строку:
# include /etc/nginx/sites-available/default/https_server.conf;