##
# app_redirects_security.conf — модуль с основными редиректами и базовой защитой.
#
# Этот файл подключается ВНУТРИ конкретного server { } (обычно HTTPS‑виртуального
# хоста) и отвечает за:
#   * канонизацию URL (убираем «мусор» из запросов и приводим их к единой форме);
#   * простые фильтры от грубых SQLi/XSS по QUERY_STRING;
#   * защиту от path traversal и прямого доступа к служебным файлам;
#   * запрет выполнения .php в /upload и блокировку чувствительных директорий;
#   * базовую защиту от хотлинкинга картинок.
#
# Как подключать:
#   server {
#       listen 443 ssl http2;
#       server_name example.com;
#       ...
#
#       include /etc/nginx/conf.d/apps/app_name/app_redirects_security.conf;
#   }
#
# В примере ниже доменом по умолчанию считается https://example.com.
# Для реального проекта замените example.com на свой домен (или несколько доменов
# в server_name) и при необходимости скорректируйте пути/плейсхолдеры.
##

############################################################
# 1. Канонизация URL и основные редиректы
############################################################

# 1.1. Редирект с /index.php и /index.html на URL без них.
#
# Пример:  https://example.com/catalog/index.php  →  https://example.com/catalog/
#          https://example.com/index.html          →  https://example.com/
#
# Это помогает убрать дубли контента для SEO и делает адреса более «чистыми».
# Исправлено: исключаем повторное перенаправление на тот же URI.
if ($request_uri ~ "^(.*/)(index\.php|index\.html)$") {
    return 301 $scheme://$host$1;
}


# 1.2. Удаляем пустой вопросительный знак в конце URL.
#
# Пример:  https://example.com/path/?   →   https://example.com/path/
#
# Такой хвост иногда появляется из‑за багов фронта или внешних ссылок и создаёт
# дубли страниц. Регулярное выражение "^[^?]*\?$" означает «строка без ? до
# самого конца, далее один ? и больше ничего».
if ($request_uri ~ "^[^?]*\?$") {
    return 301 $scheme://$host$uri;
}


# 1.3. Убираем множественные слэши в URI.
#
# Пример:  https://example.com//foo///bar  →  https://example.com/foo/bar
#
# Это также уменьшает количество дублей URL и делает логи/метрики чище.
if ($request_uri ~ "//+") {
    return 301 $scheme://$host$uri;
}


# 1.4. Нормализация завершающего слеша для путей, которые не являются файлами и не имеют расширения.
#
# Пример: https://example.com/catalog  →  https://example.com/catalog/
#
# Эта часть предотвращает цикл добавления слешей и сохраняет файлы без слеша.
# Правило проверяет, что:
#   * путь не является файлом с расширением (не содержит точку)
#   * путь не заканчивается уже на слеш
#   * путь содержит более одного сегмента или это каталог
# Исправлено: убрана проблема с бесконечным редиректом на /catalog//.


if ($needs_slash = 1) {
    return 301 $scheme://$host$uri/;
}


############################################################
# 2. Простые фильтры SQLi / XSS по QUERY_STRING
############################################################

# ВНИМАНИЕ: это только базовые проверки, они не заменяют WAF
# (ModSecurity/NAXSI/Cloud WAF и т.п.), но помогают показать типичные паттерны.
# В проде такие правила лучше дублировать/расширять на уровне специализированных
# средств защиты.

# Попытка встроить <script>...</script> через параметр в URL.
if ($query_string ~* "(\<|%3C).*script.*(\>|%3E)") {
    return 403;
}

# Попытки обратиться к суперглобальным массивам PHP (GLOBALS, _REQUEST) —
# типичный признак некоторых видов атак.
if ($query_string ~* "GLOBALS(=|\[|%[0-9A-Z]{0,2})") {
    return 403;
}

if ($query_string ~* "_REQUEST(=|\[|%[0-9A-Z]{0,2})") {
    return 403;
}

# Грубые SQLi-паттерны — union select / concat( ... ).
if ($query_string ~* "union.*select.*\(") {
    return 403;
}

if ($query_string ~* "concat.*\(") {
    return 403;
}


############################################################
# 3. Защита от path traversal и прямого доступа к конфигурации
############################################################

# Попытка подняться вверх по файловой системе через .. или закодированный %2e%2e.
if ($request_uri ~* "(\.\.|%2e%2e)") {
    return 403;
}

if ($request_uri ~* "(\.\./|\.\.)") {
    return 403;
}

# Блокируем явные обращения к системным путям.
if ($request_uri ~* "^/(etc|usr|var|tmp|root|bin|sbin)/") {
    return 403;
}

# Запрещаем скачивание/просмотр типичных конфигурационных файлов.
if ($request_uri ~* "(\.settings\.php|config\.php|configuration\.php|php\.ini|\.htaccess)") {
    return 403;
}


############################################################
# 4. Запрет .php в /upload и доступ к служебным директориям
############################################################

# Запрет выполнения .php в /upload — в этой директории должны храниться только
# файлы данных (картинки, документы и т.п.).
location ~* ^/upload/.*\.php$ {
    deny all;
}

# Запрет доступа к типичным чувствительным директориям:
#   /cgi-bin, /includes, /uploads, /tmp, /php-cgi
location ~* ^/(cgi-bin|includes|uploads|tmp|php-cgi)/ {
    deny all;
}


############################################################
# 5. Защита от хотлинкинга картинок
############################################################

# Запрещаем прямое встраивание картинок на сторонних сайтах (hotlinking).
# Разрешаем только:
#   * запросы без Referer (none) или с заблокированным/пустым Referer (blocked);
#   * запросы, пришедшие с example.com и www.example.com.
# Остальные получают заглушку /images/hotlink-placeholder.png.
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked example.com www.example.com;

    if ($invalid_referer) {
        rewrite ^ /images/hotlink-placeholder.png last;
    }
}


############################################################
# 6. Защита скрытых и служебных файлов (dot‑files, VCS, бэкапы)
############################################################

# Блокируем доступ ко всем dot-файлам, кроме .well-known (ACME и др.).
location ~ /\.(?!well-known).* {
    deny all;
}

# Дополнительная защита VCS-директорий (.git, .svn, .hg и т.п.).
location ~* /\.(git|svn|hg) {
    deny all;
}

# Блокируем типичные резервные/дамп-файлы (SQL, архивы и др.).
location ~* \.(?:bak|new|old|sql|tar|gz|tgz|zip)$ {
    deny all;
}

# Запрещаем доступ к .htaccess файлам
location ~ /\.ht {
    deny  all;
}