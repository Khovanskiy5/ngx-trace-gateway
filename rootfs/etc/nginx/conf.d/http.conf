# ===================================================================
#  HTTP-блок
# ===================================================================
#  Основные настройки HTTP-сервера и подключаемые глобальные параметры.
# ===================================================================

http {
    include       mime.types;
    default_type  application/octet-stream;

    # -------------------------------------------------------------------
    #  Глобальная карта для поддержки WebSocket Upgrade
    # -------------------------------------------------------------------
    #   Если клиент отправил заголовок Upgrade (например, WebSocket),
    #   то к бэкенду пробрасываем Connection: upgrade.
    #   Если заголовка Upgrade нет (пустая строка),
    #   Connection будет закрыт корректно.
    # -------------------------------------------------------------------
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Стандартная кодировка
    charset utf-8;

    # Разрешить повторную обработку error_page для вложенных ошибок
    # (например, если при выдаче страницы ошибки возникла ещё одна ошибка).
    recursive_error_pages on;

    # -------------------------------------------------------------------
    #  Временная директории для хранения тел запросов
    # -------------------------------------------------------------------
    client_body_temp_path /var/run/openresty/nginx-client-body;

    # -------------------------------------------------------------------
    #  Глобальные настройки (определение имени hop, tcp, proxy, rate limiting и др.)
    # -------------------------------------------------------------------
    include /etc/nginx/conf.d/globals/global_hop_name.conf;     # Определение $hop_name для логов и трейсинга
    include /etc/nginx/conf.d/globals/global_tcp.conf;          # Оптимизации TCP и ввода-вывода
    include /etc/nginx/conf.d/globals/global_proxy.conf;        # Основные настройки HTTP-проксирования (proxy_*)
    include /etc/nginx/conf.d/globals/global_fastcgi.conf;      # Глобальные параметры FastCGI (fastcgi_*)
    include /etc/nginx/conf.d/globals/global_uwsgi.conf;        # Глобальные параметры UWSGI (uwsgi_*)
    include /etc/nginx/conf.d/globals/global_scgi.conf;         # Глобальные параметры SCGI (scgi_*)
    include /etc/nginx/conf.d/globals/global_rate_limit.conf;   # Зоны и лимиты rate limiting
    include /etc/nginx/conf.d/globals/global_trace.conf;        # Трассировка и идентификаторы запросов
    include /etc/nginx/conf.d/globals/global_gzip.conf;         # Gzip-сжатие ответов
    include /etc/nginx/conf.d/globals/global_logging.conf;      # Настройки логирования
    include /etc/nginx/conf.d/globals/global_cache.conf;        # Настройки кэширования
    include /etc/nginx/conf.d/globals/global_ssl.conf;          # Настройки и оптимизация SSL
    include /etc/nginx/conf.d/globals/global_security.conf;     # Настройки безопасности
    include /etc/nginx/conf.d/globals/global_error_pages.conf;  # Страницы ошибок

    # -------------------------------------------------------------------
    #  Подключение виртуальных хостов
    # -------------------------------------------------------------------
    # Директория sites-enabled должна содержать символьные ссылки
    # на конфигурационные файлы из sites-available.
    include /etc/nginx/sites-enabled/*.conf;
}
