##
## GLOBAL UWSGI — глобальные настройки UWSGI для всех виртуальных хостов.
## Этот файл подключается в контексте
##   http {
##       ...
##       include /etc/nginx/conf.d/globals/global_uwsgi.conf;
##       ...
##   }, чтобы задать значения по умолчанию для uwsgi_* и связанных директив.
##
## При необходимости Вы можете переопределять эти значения
## в конкретных server { } и location { }.
## В Nginx действует правило: последняя директива в данном контексте имеет приоритет.
##

# Таймаут установления TCP-соединения до UWSGI-бэкенда.
uwsgi_connect_timeout 5s;

# Время ожидания ответа от UWSGI после отправки полного запроса.
uwsgi_read_timeout 10s;

# Время, в течение которого Nginx ожидает возможность отправить запрос UWSGI.
uwsgi_send_timeout 10s;

# Буферизация ответов от UWSGI.
uwsgi_buffering on;

# Размер первичного буфера для ответа от UWSGI.
uwsgi_buffer_size 16k;

# Количество и размер дополнительных буферов для ответа от UWSGI.
uwsgi_buffers 16 16k;

# Размер «занятых» буферов, при превышении которого Nginx начнёт отдавать данные клиенту
# даже если ответ от backend ещё не дочитан полностью.
uwsgi_busy_buffers_size 32k;

# Путь для временных файлов UWSGI (если включена запись во временные файлы).
# Должен соответствовать настройке в http.conf.
uwsgi_temp_path /var/run/openresty/nginx-uwsgi;

# Поведение при ошибках связи с backend (переход к следующему upstream-серверу по списку).
uwsgi_next_upstream error timeout;
uwsgi_next_upstream_tries 3;

# Базовые параметры, пробрасываемые в UWSGI-приложение.
# Обратите внимание: обычно они задаются через include uwsgi_params; в location,
# но здесь мы задаём их глобально как значения по умолчанию (безопасно переопределяются
# в более узком контексте).
uwsgi_param QUERY_STRING $query_string;
uwsgi_param REQUEST_METHOD $request_method;

# Опциональный модификатор протокола UWSGI. Оставьте закомментированным, если не требуется.
uwsgi_modifier1 30;

# Базовый набор CGI-переменных для uWSGI-бекенда.
# Файл uwsgi_params обычно входит в стандартный пакет Nginx.
include uwsgi_params;

# Дополнительные параметры, полезные для проксирования веб-приложений через uWSGI.
uwsgi_param Host              $host;
uwsgi_param X-Real-IP         $remote_addr;
uwsgi_param X-Forwarded-For   $proxy_add_x_forwarded_for;
uwsgi_param X-Forwarded-Proto $scheme;

# Трассирующие заголовки для uWSGI-приложений:
# Все hop/trace/mob идентификаторы передаются как CGI-переменные, чтобы backend мог
# реализовать единую логику из technical-spec-tracing.md.
uwsgi_param X-Request-ID         $trace_request_id;
uwsgi_param X-Prev-Request-ID    $local_request_id;      # вниз всегда свой local_request_id
uwsgi_param X-Request-Chain      $request_hops_chain;
uwsgi_param X-Mobile-Launch-ID   $mobile_launch_id;
uwsgi_param X-Mobile-Request-ID  $mobile_request_id;

# По умолчанию кэш uWSGI отключён (включайте точечно при необходимости via uwsgi_cache ZONE;).
uwsgi_cache off;

# Ключ кэша uWSGI (при включенном uwsgi_cache в нужном location).
uwsgi_cache_key "$scheme$request_method$host$request_uri$http_authorization";

# Игнорируем origin-заголовки для управления кэшированием на стороне Nginx.
uwsgi_ignore_headers Expires Cache-Control Set-Cookie Vary;

# Скрываем Set-Cookie из ответа uWSGI — позволяет кэшировать non-personalized ответы.
uwsgi_hide_header "Set-Cookie";

# Защита от thundering herd.
uwsgi_cache_lock on;
uwsgi_cache_lock_timeout 5s;

# Фоновое обновление и revalidate при поддержке ETag/Last-Modified.
uwsgi_cache_background_update on;
uwsgi_cache_revalidate on;

# Срок кэширования успешных ответов по умолчанию.
uwsgi_cache_valid 200 1h;

## Заголовок X-Proxy-Cache уже добавляется глобально в global_proxy.conf (http {}).
## Дополнительный заголовок для uWSGI не добавляем, чтобы избежать дублирования.

# Обратите внимание: все эти настройки являются значениями по умолчанию.
# В конкретных server { } / location { } Вы можете установить иные uwsgi_* параметры,
# которые будут переопределять глобальные значения для соответствующего контекста.


