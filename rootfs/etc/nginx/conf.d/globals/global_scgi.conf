##
## GLOBAL SCGI — глобальные настройки SCGI для всех виртуальных хостов.
## Этот файл подключается в контексте
##   http {
##       ...
##       include /etc/nginx/conf.d/globals/global_scgi.conf;
##       ...
##   }, чтобы задать значения по умолчанию для scgi_* и связанных директив.
##
## При необходимости Вы можете переопределять эти значения
## в конкретных server { } и location { }.
## В Nginx действует правило: последняя директива в данном контексте имеет приоритет.
##

# Таймаут установления соединения до SCGI-бэкенда.
scgi_connect_timeout 5s;

# Время ожидания ответа от SCGI после отправки полного запроса.
scgi_read_timeout 10s;

# Время, в течение которого Nginx ожидает возможность отправить запрос SCGI.
scgi_send_timeout 10s;

# Буферизация ответов от SCGI.
scgi_buffering on;

# Размер первичного буфера для ответа от SCGI.
scgi_buffer_size 16k;

# Количество и размер дополнительных буферов для ответа от SCGI.
scgi_buffers 16 16k;

# Размер «занятых» буферов, при превышении которого Nginx начнёт отдавать данные клиенту
# даже если ответ от backend ещё не дочитан полностью.
scgi_busy_buffers_size 32k;

# Путь для временных файлов SCGI
scgi_temp_path /var/run/openresty/nginx-scgi;

# Поведение при ошибках связи с backend.
scgi_next_upstream error timeout;
scgi_next_upstream_tries 3;

# По умолчанию кэш SCGI отключён (включайте точечно при необходимости via scgi_cache ZONE;).
scgi_cache off;

# Ключ кэша SCGI (при включенном scgi_cache в нужном location).
scgi_cache_key "$scheme$request_method$host$request_uri$http_authorization";

# Игнорируем origin-заголовки для управления кэшированием на стороне Nginx.
scgi_ignore_headers Expires Cache-Control Set-Cookie Vary;

# Скрываем Set-Cookie из ответа SCGI — позволяет кэшировать non-personalized ответы.
scgi_hide_header "Set-Cookie";

# Защита от thundering herd.
scgi_cache_lock on;
scgi_cache_lock_timeout 5s;

# Фоновое обновление и revalidate при поддержке ETag/Last-Modified.
scgi_cache_background_update on;
scgi_cache_revalidate on;

# Срок кэширования успешных ответов по умолчанию.
scgi_cache_valid 200 1h;

## Заголовок X-Proxy-Cache уже добавляется глобально в global_proxy.conf (http {}).
## Дополнительный заголовок для SCGI не добавляем, чтобы избежать дублирования.

# Базовые параметры, пробрасываемые в SCGI-приложение.
# Включаем стандартный набор CGI‑переменных.
include scgi_params;

# Дополнительные параметры окружения для веб‑приложения через SCGI.
scgi_param Host              $host;
scgi_param X-Real-IP         $remote_addr;
scgi_param X-Forwarded-For   $proxy_add_x_forwarded_for;
scgi_param X-Forwarded-Proto $scheme;

# Трассировка: пробрасываем идентификаторы и цепочку hop'ов.
scgi_param X-Request-ID         $trace_request_id;
scgi_param X-Prev-Request-ID    $local_request_id;    # вниз всегда свой local_request_id
scgi_param X-Request-Chain       $request_hops_chain;
scgi_param X-Mobile-Launch-ID   $mobile_launch_id;
scgi_param X-Mobile-Request-ID  $mobile_request_id;

# Обратите внимание: все эти настройки являются значениями по умолчанию.
# В конкретных server { } / location { } Вы можете установить иные scgi_* параметры,
# которые будут переопределять глобальные значения для соответствующего контекста.

