##
## Глобальные настройки rate limiting (limit_req_zone) для всего Nginx.
## Этот файл подключается ТОЛЬКО в контексте http { } (см. nginx.conf),
## т.к. директивы limit_req_zone и map допустимы именно там.
##
## Общие принципы и популярные практики:
##   1) Ключ (key) зоны — это то, по чему считаются запросы:
##      - $binary_remote_addr  — ограничение по IP-адресу клиента (экономно по памяти);
##      - $remote_addr         — то же, но менее экономично (строка);
##      - произвольная переменная (например, $jwt_sub, $session_id, $api_key) —
##        когда хотим лимитировать не IP, а пользователя/токен.
##
##   2) zone=<имя>:<размер> — название зоны и объём памяти под счётчики.
##      Оценка памяти: ~64–128 байт на уникальный ключ; 10m хватает на десятки/сотни тысяч ключей.
##
##   3) rate=<число>r/s или r/m — средний допустимый поток запросов
##      (r/s — запросов в секунду, r/m — в минуту). «Поведение под всплеск» настраивается
##      в limit_req (burst, delay, nodelay) уже внутри server/location.
##
##   4) Рекомендуемый паттерн:
##      - Отдельная зона для чувствительных операций (логин, пароль, SMS-код);
##      - Отдельная зона для обычного API (мягче);
##      - При необходимости — зона для админки и/или внутренних клиентов.
##
##   5) Часто комбинируют два лимита в одном location:
##      - по IP (защита от грубых атак);
##      - по пользователю/токену (усмиряет «шумных» легитимных клиентов).
##
################################################################################
## Блок вспомогательных переменных (map) — безопасные ключи для зон
## Размещается здесь, чтобы переменные были доступны всем downstream-конфигам.
################################################################################

# Идентификатор потребителя API (из заголовка X-Consumer-Id). Если заголовка нет — "anon".
map $http_x_consumer_id $api_consumer_id {
    default $http_x_consumer_id;
    ""      "anon";
}

# Ключ API из заголовка X-Api-Key. Если ключа нет — "anon" (полезно, чтобы считать анонимов).
map $http_x_api_key $rl_api_key {
    default $http_x_api_key;
    ""      "anon";
}

################################################################################
## БОЕВЫЕ ЗОНЫ ДЛЯ RATE LIMITING
## Эти директивы создают счётчики; реальное ограничение включается в server/location.
################################################################################

# 1) Чувствительные операции (логин/пароль/2FA/SMS). Жёсткий IP‑лимит.
limit_req_zone $binary_remote_addr zone=app_login:10m        rate=5r/s;

# 2) Очень жёсткий лимит для security‑critical endpoint'ов (например, выдача SMS‑кодов).
limit_req_zone $binary_remote_addr zone=security_sensitive:5m rate=1r/s;

# 3) Публичный API по IP (мягкий лимит, типичный REST).
limit_req_zone $binary_remote_addr zone=public_api_ip:20m     rate=60r/m;

# 4) Публичный API по пользователю/клиенту (заголовок X-Consumer-Id).
limit_req_zone $api_consumer_id   zone=public_api_user:20m    rate=120r/m;

# 5) Публичный API по API‑ключу (заголовок X-Api-Key), более строгий rps.
limit_req_zone $rl_api_key        zone=public_api_key:20m     rate=10r/s;

# 6) Административная зона (IP‑лимит). Даже для малочисленных админов полезно ограничение.
limit_req_zone $binary_remote_addr zone=admin_area:5m         rate=10r/s;

# 7) Внутренние клиенты (IP‑лимит). Щадящий лимит, чтобы отсечь runaway‑клиентов.
limit_req_zone $binary_remote_addr zone=internal_clients:10m  rate=200r/s;

################################################################################
## ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ (server/location) — раскомментируйте в нужных vhost'ах
##
## ВНИМАНИЕ: limit_req используется только в контексте server { } / location { }.
## Здесь приведены шаблоны — оставлены закомментированными, т.к. этот файл подключается в http {}
################################################################################

## 1) Жёсткий лимит для формы логина без задержек (мгновенно отдаём 429):
# location = /login {
#     limit_req zone=app_login burst=5 nodelay;
#     limit_req_status 429;            # по умолчанию 503
#     try_files @proxy_login =404;     # пример: свой upstream/роутинг
# }

## 2) Комбинация лимита по IP и по пользователю для /api/:
# location ^~ /api/ {
#     limit_req zone=public_api_ip   burst=120  delay=60;  # мягкий сглаживающий burst
#     limit_req zone=public_api_user burst=240  delay=120; # отдельный лимит по клиенту
#     proxy_pass http://backend_api;
# }

## 3) Лимит по API‑ключу. Анонимов считаем как ключ "anon":
# location ^~ /api/v2/ {
#     limit_req zone=public_api_key burst=20 nodelay;
#     proxy_pass http://backend_v2;
# }

## 4) Security‑sensitive endpoint (выдача SMS/код подтверждения):
# location = /auth/send_code {
#     limit_req zone=security_sensitive burst=1 nodelay;
#     proxy_pass http://auth_backend;
# }

## 5) Админка: умеренный лимит + dry_run для проверки политики в бою без блокировок:
# server {
#     server_name admin.example.com;
#     limit_req_dry_run on;           # включаем для всего server — только логируем превышения
#     location / {
#         limit_req zone=admin_area burst=20 delay=5;
#         proxy_pass http://admin_ui;
#     }
# }

## 6) Внутренние сервисы: щадящий лимит, чтобы не уронить backend при runaway‑клиенте:
# location /internal/ {
#     allow 10.0.0.0/8;
#     deny  all;
#     limit_req zone=internal_clients burst=500 delay=100;
#     proxy_pass http://internal_backend;
# }

## ПАМЯТКА:
##  - Директива limit_req_zone создаёт зону и счётчики (только в http{}).
##  - Директива limit_req включает ограничение (server/location). Можно объявить несколько
##    limit_req в одном контексте — будут применяться все.
##  - Для диагностики используйте: limit_req_dry_run on; limit_req_status 429; логи.
##  - При изменении набора зон перезапустите/перечитайте конфиг (reload).