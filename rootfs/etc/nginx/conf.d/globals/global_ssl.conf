##
# Глобальные SSL/TLS настройки под высокую нагрузку и безопасность
##


# Включение TLS только на HTTPS-порт 443
# Поддерживаем современные протоколы
ssl_protocols TLSv1.2 TLSv1.3;

# Набор шифров для TLS 1.2. Для TLS 1.3 шифры задаются автономно и не зависят от этой директивы.
# Сюда включены только надёжные шифросuites без устаревших алгоритмов (без RC4, 3DES и т.д.).
# Строку можно взять из современных рекомендаций (Mozilla modern / intermediate).
ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

# Принудительная настройка шифров сервером, разрешает только шифры из ssl_ciphers,
# НЕ позволять клиенту выбирать слабые алгоритмы.
ssl_prefer_server_ciphers on;

# TLS Кэш сессий на стороне сервера и таймауты:
# Это сильно уменьшает количество полноценных TLS‑handshake при повторных подключениях клиентов.
ssl_session_cache   shared:SSL:50m; # выделяем ~50 МБ под кэш TLS-сессий, этого хватит очень многим соединениям.
ssl_session_timeout 10m; # запоминаем сессии в течение 10 минут.

# TLS session tickets
ssl_session_tickets off;

# Параметр DH (Diffie-Hellman) в TLS необходим для обеспечения Forward Secrecy (FS) — секретности будущих
# сессий даже если текущий ключ сервера станет известен злоумышленнику.
# Включение DH параметров в конфигурацию nginx повышает безопасность TLS-соединений за счёт
# использования одноразовых ключевых пар для каждой ручной части протокола.
# Выполните команду: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048 или 4096
# ssl_dhparam /etc/nginx/ssl/dhparam.pem;


# OCSP stapling — ускоряет проверки статуса SSL-сертификата и повышения приватности пользователей.
# Позволяет веб-серверу запрашивать у центра проверки статуса (OCSP-сервера) актуальное состояние сертификата,
# кэшировать этот ответ и отправлять его клиенту вместе с TLS-рукопожатием,
# без необходимости отдельного обращения браузера к OCSP-серверу.
# Это сокращает задержки в установлении SSL-соединения и снижает нагрузку на центр сертификации,
# улучшая производительность и приватность.
ssl_stapling on;
ssl_stapling_verify on;

# Резолвер DNS для OCSP stapling
resolver 1.1.1.1 8.8.8.8 valid=300s;
resolver_timeout 5s;

# Путь к цепочке доверия для OCSP stapling
# ssl_trusted_certificate /etc/ssl/certs/ca_chain.pem;

# HSTS — включайте только если все домены обслуживаются через HTTPS постоянно
# Лучше включать для каждого блока server { ... } отдельно. Здесь эта информация для консистентности.
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;


# Примечание: ssl_certificate, ssl_certificate_key и ssl_trusted_certificate должны быть
# указаны внутри конкретного server { ... } блока, где требуется TLS.

# Пример использования в типичной конфигурации server блоков ниже:
#
# server {
#     listen 443 ssl http2;
#     server_name example.com www.example.com;
#     ssl_certificate /path/to/your/fullchain.pem;        # содержит сертификат и цепочку
#     ssl_certificate_key /path/to/your/private.key;      # приватный ключ
#     ssl_trusted_certificate /path/to/ca_chain.pem;      # цепочка доверия
#
#     # Остальная конфигурация
#     ...
# }

