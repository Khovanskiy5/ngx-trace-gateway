# Настройки кэша и связанных вещей, общих для всех server { }.
# Этот блок задаёт общую зону кэша и параметры кеширования на уровне всего http {},
# чтобы все server { } и location { } могли использовать одну и ту же зону через proxy_cache.

# Определяем зону proxy_cache:
# - /var/cache/nginx/gate — каталог на диске, куда Nginx будет складывать кэш-файлы.
#   Важно: каталог должен существовать и быть доступен пользователю, под которым работает Nginx.
# - levels=1:2 — схема вложенных каталогов кэша. Первый уровень — 1 символ, второй — 2 символа
#   из хеша ключа. Это нужно, чтобы не было десятков тысяч файлов в одном каталоге и
#   файловая система работала быстрее.
# - keys_zone=appcache:128m — именованная зона в общей памяти (shared memory), где хранится
#   индекс кэша (ключи, метаданные, флаги). 128m — объём памяти под индекс (НЕ сами данные).
# - inactive=60m — объект удаляется из кэша, если к нему не обращались 60 минут, даже если срок
#   жизни по Cache-Control/Expires ещё не истёк.
# - max_size=10g — общий лимит размера кэша на диске. При превышении Nginx начнёт очищать
#   самые старые/неиспользуемые записи.
# - use_temp_path=off — временные файлы для кэша пишутся сразу в каталог кэша, а не во
#   временный системный каталог. Это уменьшает лишние перемещения файлов и улучшает I/O.
proxy_cache_path /var/cache/nginx/gate levels=1:2 keys_zone=appcache:128m inactive=60m max_size=10g use_temp_path=off;

# Кэш файловых дескрипторов и метаданных.
# Nginx очень часто обращается к одним и тем же файлам (конфиг, статика, лог-файлы),
# и постоянные системные вызовы stat()/open() могут быть дорогими.
# open_file_cache позволяет держать информацию о файлах в памяти и резко сокращает
# количество обращений к файловой системе.

# max=2000 — максимум записей в кэше (описаний файлов).
# inactive=20s — удалить запись из кэша, если к ней не обращались 20 секунд.
open_file_cache          max=2000 inactive=20s;

# open_file_cache_valid — как часто Nginx будет пересматривать (валидировать) записи в кэше.
# Здесь раз в 60 секунд проверяется, что информация о файлах всё ещё актуальна.
open_file_cache_valid    60s;

# open_file_cache_min_uses — кэшировать только те файлы, к которым обратились N или более раз
# за период inactive. Это фильтр против «шума» от редких обращений: закэшированными
# будут только популярные файлы.
open_file_cache_min_uses 5;

# open_file_cache_errors — кэшировать информацию об ошибках доступа к файлам
# (например, что файл не существует). Это уменьшает количество повторных бесполезных
# системных вызовов к несуществующим ресурсам и ускоряет обработку таких запросов.
open_file_cache_errors   on;