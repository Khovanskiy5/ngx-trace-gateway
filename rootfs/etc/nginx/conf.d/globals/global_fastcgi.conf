##
## GLOBAL FASTCGI — глобальные настройки FastCGI для всех виртуальных хостов.
## Этот файл подключается в контексте
##   http {
##       ...
##       include /etc/nginx/conf.d/globals/global_fastcgi.conf;
##       ...
##   }, чтобы задать значения по умолчанию для fastcgi_* и связанных директив.
##
## При необходимости Вы можете переопределять эти значения
## в конкретных server { } и location { }.
## В Nginx действует правило: последняя директива в данном контексте имеет приоритет.
##

# Таймаут установления TCP-соединения до FastCGI-бэкенда (например, php-fpm).
fastcgi_connect_timeout 5s;

# Время ожидания ответа от FastCGI после отправки полного запроса.
fastcgi_read_timeout 10s;

# Время, в течение которого Nginx ожидает возможность отправить запрос FastCGI.
fastcgi_send_timeout 10s;

# Буферизация ответов от FastCGI.
# Включена по умолчанию для снижения нагрузки на backend и ровной отдачи клиентам.
fastcgi_buffering on;

# Размер первичного буфера для ответа от FastCGI.
fastcgi_buffer_size 16k;

# Количество и размер дополнительных буферов для ответа от FastCGI.
fastcgi_buffers 16 16k;

# Размер «занятых» буферов, при превышении которого Nginx начнёт отдавать данные клиенту
# даже если ответ от backend ещё не дочитан полностью.
fastcgi_busy_buffers_size 32k;

# Путь для временных файлов FastCGI.
fastcgi_temp_path /var/run/openresty/nginx-fastcgi;

# Явно отключаем FastCGI‑кэш по умолчанию (включайте точечно при необходимости via fastcgi_cache ZONE;).
fastcgi_cache off;

# Поведение при ошибках связи с backend: списки событий/кодов, при которых можно
# обратиться к следующему upstream-серверу из группы.
fastcgi_next_upstream error timeout;
fastcgi_next_upstream_tries 3;


# Стандартный набор CGI‑переменных для FastCGI-бекенда.
# Файл fastcgi_params обычно входит в стандартный пакет Nginx.
include fastcgi_params;

# Корректно передаём путь к скрипту в бекенд.
# Предполагается, что DOCUMENT_ROOT уже задан (например, через директиву root в server { }).
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME     $fastcgi_script_name;

# Базовые заголовки/параметры окружения для веб‑приложения через FastCGI.
fastcgi_param Host              $host;
fastcgi_param X-Real-IP         $remote_addr;
fastcgi_param X-Forwarded-For   $proxy_add_x_forwarded_for;
fastcgi_param X-Forwarded-Proto $scheme;

# Трассирующие идентификаторы (см. global_trace.conf):
# Пробрасываем сквозной ID, цепочку hop'ов и мобильные идентификаторы.
fastcgi_param X-Request-ID         $trace_request_id;
fastcgi_param X-Prev-Request-ID    $local_request_id;    # вниз всегда свой local_request_id
fastcgi_param X-Request-Chain      $request_hops_chain;
fastcgi_param X-Mobile-Launch-ID   $mobile_launch_id;
fastcgi_param X-Mobile-Request-ID  $mobile_request_id;

# Ключ кэша FastCGI (используется, если включите fastcgi_cache в нужном location):
fastcgi_cache_key "$scheme$request_method$host$request_uri$http_authorization";

# Игнорируем некоторые заголовки origin, чтобы управлять кэшированием на стороне Nginx.
fastcgi_ignore_headers Expires Cache-Control Set-Cookie Vary;

# Скрываем Set-Cookie из ответа FastCGI — позволяет кэшировать non-personalized ответы.
fastcgi_hide_header "Set-Cookie";

# Защита от thundering herd при обновлении кэша.
fastcgi_cache_lock on;
fastcgi_cache_lock_timeout 5s;

# Обновление кэша в фоне и revalidate при поддержке ETag/Last-Modified.
fastcgi_cache_background_update on;
fastcgi_cache_revalidate on;

# Срок кэширования успешных ответов по умолчанию.
fastcgi_cache_valid 200 1h;

## Заголовок X-Proxy-Cache уже добавляется глобально в global_proxy.conf (http {}).
## Дополнительный заголовок для FastCGI не добавляем, чтобы избежать дублирования.

# Обратите внимание: все эти настройки являются значениями по умолчанию.
# В конкретных server { } / location { } Вы можете установить иные fastcgi_* параметры,
# которые будут переопределять глобальные значения для соответствующего контекста.

