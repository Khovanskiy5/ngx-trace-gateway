######################################################################
# global_metrics.conf — встроенные метрики Nginx (stub_status)
#
# Назначение:
#   - Поднять отдельный служебный сервер на 8080 порту внутри контейнера,
#     чтобы отдавать внутреннюю страницу /nginx_status (stub_status).
#   - Доступ ограничен только локальной машиной и приватными подсетями
#     (для Docker bridge-сетей и кластеров). Снаружи хоста порт не пробрасывается.
#
# Использование:
#   - Экспортер Prometheus будет снимать метрики по URI:
#       http://openresty:8080/nginx_status
#     (имя «openresty» — это имя сервиса в docker-compose).
#   - Для локальной проверки внутри контейнера:
#       docker exec -it openresty curl -s http://127.0.0.1:8080/nginx_status
######################################################################

server {
    listen 0.0.0.0:8080;   # только внутри docker‑сети (порт не пробрасывается наружу)
    server_name localhost;

    access_log off;
    error_log  /var/log/nginx/metrics.error.log;

    location = /nginx_status {
        stub_status;      # активирует /nginx_status
        access_log off;   # не логируем запросы метрик

        # Разрешаем только локальный хост и приватные сети (Docker/интранет)
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny  all;
    }
}
